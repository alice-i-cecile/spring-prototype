<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Spring Prototype</title>
    <link href="/stylesheets/screen.css" media="all" rel="stylesheet" type="text/css"/>
    <script language="javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js" type="text/javascript"></script><script language="javascript" src="javascripts/jquery.hotkeys.js" type="text/javascript"></script><script language="javascript" src="javascripts/key_status.js" type="text/javascript"></script><script language="javascript" src="javascripts/util.js" type="text/javascript"></script><script language="javascript" src="javascripts/sprite.js" type="text/javascript"></script><script language="javascript" src="javascripts/sound.js" type="text/javascript"></script>
  </head>
  <body>
    <h1>Spring Prototype</h1>
    <script type='text/javascript'>
      //<![CDATA[
        var CANVAS_WIDTH = 1600;
        var CANVAS_HEIGHT = 900;
        var FPS = 30;

        var GRAVITY = 0.8;

        var canvasElement = $("<canvas width='" + CANVAS_WIDTH +
          "' height='" + CANVAS_HEIGHT + "'></canvas");
        var canvas = canvasElement.get(0).getContext("2d");
        canvasElement.appendTo('body');

        setInterval(function() {
          update();
          draw();
        }, 1000/FPS);

        var player = {
          x: CANVAS_WIDTH/2,
          y: CANVAS_HEIGHT/2,
          v_x: 0,
          v_y: 0,
          acceleration_rate: 1,
          drag_coefficient: 0.01,
          elasticity: 0.8,
          radius: 15,
          draw: function() {
            canvas.beginPath();
            canvas.arc(this.x, this.y,
              this.radius,
              0, 2*Math.PI);
            canvas.stroke();
          }
        };

        function check_collisions() {
          if (player.x < player.radius || player.x > CANVAS_WIDTH - player.radius){
            player.v_x *= -player.elasticity;
          }

          if (player.y < player.radius || player.y > CANVAS_HEIGHT - player.radius){
            player.v_y *= -player.elasticity;
          }

          // Enforce existence in game area
          player.x = player.x.clamp(player.radius, CANVAS_WIDTH - player.radius);
          player.y = player.y.clamp(player.radius, CANVAS_HEIGHT - player.radius);
        }

        function controls() {
          // Correct for faster diagonal movement
          // Sum of vectors must be same as in case where moving along one axis
          // so each is scaled by 1/sqrt(2)
          step_acceleration_rate = player.acceleration_rate
          if ((keydown.left || keydown.right) && (keydown.up || keydown.down)){
            step_acceleration_rate *= 0.70710678118
          }

          // Movement controls
          if(keydown.left) {
            player.v_x -= step_acceleration_rate;
          }

          if(keydown.right) {
            player.v_x += step_acceleration_rate;
          }

          if(keydown.up) {
            player.v_y -= step_acceleration_rate;
          }

          if(keydown.down) {
            player.v_y += step_acceleration_rate;
          }
        }

        function update() {
          // Controls
          controls();

          // Gravity
          player.v_y += GRAVITY;

          // Drag
          player.v_x *= 1 - player.drag_coefficient;
          player.v_y *= 1 - player.drag_coefficient;

          // Movement
          player.x += player.v_x;
          player.y += player.v_y;

          // Collisions
          check_collisions();

        }

        function draw() {
          canvas.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
          canvas.strokeRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
          player.draw();
        }

      //]]>
    </script>
  </body>
</html>
